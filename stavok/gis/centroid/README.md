# Центроїд гео точок

220817, OleghBond

Це черговий мій опус з обробки геоданих.

## Середовище

Особливість цього фрагменту в тому, що він створений у середовищі [*Google Colab*](https://colab.research.google.com/). Таким чином фактично я запускаю свої застосунки на зовнішньому сервері з допомогою [*Jupyter Notebook*](https://jupyter.org/) і *Python* без необхідності встановлювати у себе всі ці штуки. Як клієнту мені потрібний лише бравзер і обліковка в Google.

Середовище *Jupyter Notebook* корисно тим, що дає можливість вести власний код як rich formatted текст з використанням популярної мови розмітки [*Markdown*](https://gist.github.com/Jekins/2bf2d0638163f1294637), включно з математичними формулами в стилі [*LaTeX*](https://katex.org/docs/supported.html).

Підсумовуючи, можу сказати – це дуже зручна штука для складання прототипів або концептів у "похідних" умовах.

## Задача

Власне постановка завдання сформульована наступним чином:

Ви отримали звичайний ("плаский") текст, в якому в описі представлені географічні координати декількох точок. Вам потрібно швидко знайти центроїд (центр мас) всіх точок в тексті, оцінити розмір групи і відобразити все це на мапі.

Загальний порядок дій виглядатиме наступним чином:

1) простий інтерфейс для введення вхідних даних і параметрів
2) розбрати (parse) текст - знайти в ньому всі пари чисел (шир, довг) у певному визначеному форматі
3) знайти центроід знайдених точок та статистично визначений розмір групи
4) підготувати дані для зчитування
5) відобразити на карті точки і розмір області

## Рішення

Робочий працюючий онлайн код представлений за [цією адресою](https://colab.research.google.com/drive/1yucRNSL4sPshdHIQgU1zwXfdbxYPwKRV). Для запуску коду потрібно спочатку залогінитись у Google, а потім підключити зовнішній сервер - праворуч вгорі є кнопка "*Підключитися*". Після підключення код можна запускати або в цілому або покроково: подивіться спадне меню "*Середовище виконання*" для ознайомлення з варіантами запуску.

Код складається з "клітинок" для запуску (власне виконавчий *Python* код) і блоку коментарів (*Markdown* текст). Ліворуч кожної клітинки запуску можна побачити значок типу `[ ]` або :arrow_forward:. Натиснувши цей значок ви запускаєте повністю всю клітинку коду.

У нашому випадку раджу запускати код послідовно покроково. Виконавчий код складається з декількох клітинок:

1. *Ініціалізація*

   Тут імпортуються потрібні модулі. **Цю клітинку достатньо запустити один раз на початку сесії.** Якщо сесія закрилась, наприклад, після тривалої паузи, то цю клітинку (як і всі нижче) треба запускати знову.

2. *Параметри розрахунків*

   Тут ви бачите декілька параметрів розрахунку, які можна міняти за потреби. **Як першого разу, так і після кожної зміни параметрів клітинку треба перезапустити.**

3. *Скопіюйте вхідний текст сюди*

   Сюди ви копіюєте вхідний текст, що містить координати декількох точок у визначених наперед форматах. Формат координат визначається параметром `coord_format` у розділі "*Параметри розрахунків*" вище. Приклади тексту для аналізу для різних форматів координат наведені у розділі коментарів "*Зразки вхідного тексту*". 

4. *Розрахунок*

   Тут все просто - запустили клітинку і побачили під нею результат розрахунку.

5. *Візуалізація*

   Тут теж все просто - запустили клітинку і побачили мапу з результатом.

Далі повертаєтесь до пункту 3 або, у разі зміни параметрів, до пункту 2.

## Виконавчий код

Кому цікаво. можуть подивитись вихідний код у [*Github* фолдері](https://github.com/protw/airscape/tree/master/stavok/gis/centroid), або конкретно:

* Основний *ipynb*-модуль — [centroid_calc_colab.ipynb](centroid_calc_colab.ipynb)
* Основний *py*-модуль — [centroid_calc_colab.py](centroid_calc_colab.py) - цей код створений завантаженням *ipynb*-модуля як *.py* без подальших коригувань і може бути запущений з командного рядка ОС або під будь-якою інтегрованою оболонкою (IDE), наприклад, *spyder*:

  ```
  python centroid_calc_colab.py
  ```
* Допоміжний модуль — [centroid_util_colab.py](centroid_util_colab.py)

**NB:** Код враховує деякі відмінності окремих середовищ таким чином, щоб без змін працювати у трьох середовищах: 1) *Jupyter Notebook* на локальному комп'ютері, 2) *Jupyter Notebook* на *Google Colab*, 3) безпосередньо в *Python*.

## Веб застосунок

Ще один варіант запуску `.ipynb` у вигляді веб застосунку з використанням [*Mercury*](https://mljar.com/mercury/). Але в цьому випадку код прийдеться переробити. Блокнот для запуску під *Mercury* представлений тут: [centroid_calc_mercury.ipynb](centroid_calc_mercury.ipynb).

До запуску потрібно встановити *Mercury* з командного рядка ОС з допомогою *pip* ([Installation - Mercury Docs](https://mercury-docs.readthedocs.io/en/latest/installation/)):

```
pip install mljar-mercury
```

або з *conda*:

```
conda install -c conda-forge mljar-mercury
```

і, про всяк випадок, перевірити працездатність:

```
mercury run demo
```

Після цього запустити веб застосунок локально, скориставшись командою:

```
mercury run centroid_calc_mercury.ipynb
```

і відкрити веб-бравзер за адресою `http://127.0.0.1:8000`.